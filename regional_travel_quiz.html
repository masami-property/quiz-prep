<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>åœ°åŸŸé™å®šæ—…è¡Œæ¥­å‹™å–æ‰±ç®¡ç†è€…è©¦é¨“ éå»å•ã‚¯ã‚¤ã‚º</title>
    <style>
        html {
            overflow-y: scroll;
        }
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f4;
            color: #333;
        }
        .container {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            max-width: 800px;
            margin: 0 auto;
        }
        .q-sec {
            margin-bottom: 20px;
            padding-bottom: 20px;
        }
        .question {
            font-size: 1em;
            margin-bottom: 15px;
            font-weight: bold;
        }
        .options label {
            display: block;
            background-color: #e9e9e9;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .options label:hover {
            background-color: #dcdcdc;
        }
        .options input[type="checkbox"] {
            margin-right: 10px;
        }
        .feedback {
            margin-top: 15px;
            font-weight: bold;
            text-align: center;
        }
        .feedback.correct {
            color: #28a745;
        }
        .feedback.incorrect {
            color: #dc3545;
        }
        .btn, button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s;
            margin: 0 5px;
        }
        .btn:hover, button:hover {
            background-color: #0056b3;
        }
        .btn:disabled, button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .actions {
            text-align: center;
            margin-top: 20px;
        }
        #score {
            text-align: center;
            font-size: 1.5em;
            font-weight: bold;
            margin-top: 20px;
            margin-bottom: 10px;
            color: #0056b3;
        }
        .options label.correct {
            border: 2px solid #28a745;
            background-color: #d4edda;
        }
        .options label.incorrect {
            border: 2px solid #dc3545;
            background-color: #f8d7da;
        }
        #explanation {
            white-space: pre-line;
            line-height: 1.6;
            margin-top: 15px;
            padding: 15px;
            background-color: #f8f9fa;
            border-left: 4px solid #007bff;
            border-radius: 0 5px 5px 0;
        }
        .explanation-toggle {
            display: block;
            margin: 15px auto 0 auto;
            width: auto;
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s;
        }

        .explanation-toggle:hover {
            background-color: #0056b3;
        }
        .short-explanation {
            font-weight: bold;
            color: #495057;
        }
        .detailed-explanation {
            margin-top: 10px;
            color: #6c757d;
        }
    </style>
</head>
<body>
<div class="container">
    <h2 style="text-align: center;">åœ°åŸŸé™å®šæ—…è¡Œæ¥­å‹™å–æ‰±ç®¡ç†è€… éå»å•ã‚¯ã‚¤ã‚º</h2>
    <div class="q-sec">
        <div class="question" id="question"></div>
        <div class="options" id="options"></div>
        <div class="feedback" id="feedback"></div>
        <button id="explanation-toggle" class="explanation-toggle" style="display:none;">ğŸ“– è§£èª¬ã‚’è¦‹ã‚‹</button>
        <div id="explanation" style="display:none;"></div>
    </div>
    <div class="actions">
        <button id="submit">â–¶ï¸ è§£ç­”ã™ã‚‹</button>
        <button id="next" disabled>â¡ï¸ æ¬¡ã®å•é¡Œ</button>
        <div id="score"></div>
        <button id="restart" style="display:none;">ğŸ”„ ã‚„ã‚Šç›´ã™</button>
        <div id="back-to-top-container" style="display:none; margin-top: 15px;">
            <a href="index.html" style="text-decoration: underline; color: #007bff;">ãƒˆãƒƒãƒ—ã«æˆ»ã‚‹</a>
        </div>
    </div>
</div>

<script>
    let allQuizzes = [], currentQuizSet = [], currentQuizIndex = 0, score = 0;
    const NUM_QUESTIONS = 10;
    const $ = id => document.getElementById(id);

    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    async function loadQuizzes() {
        try {
            const response = await fetch('data/quiz_data.json');
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            allQuizzes = await response.json();

            // ğŸ”§ åŠ å·¥å‡¦ç†ï¼ˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆâ†’é…åˆ—ã€answer â†’ answer_keysã€èª¬æ˜èª¿æ•´ï¼‰
            allQuizzes = allQuizzes.map(q => {
                const optionsArray = Object.entries(q.options).map(([key, val]) => ({
                    key,
                    text: val.text,
                    explanation: val.explanation
                }));

                return {
                    ...q,
                    options: optionsArray,
                    answer_keys: q.answer,
                    explanation: q.full_explanation || '',
                };
            });

            if (!Array.isArray(allQuizzes) || allQuizzes.length === 0) {
                throw new Error('ã‚¯ã‚¤ã‚ºãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            }

            currentQuizSet = shuffleArray([...allQuizzes]).slice(0, NUM_QUESTIONS);
            currentQuizIndex = 0;
            score = 0;
            $('score').innerText = '';
            $('restart').style.display = 'none';
            $('back-to-top-container').style.display = 'none';
            displayQuiz();
        } catch (error) {
            console.error('Error loading quiz data:', error);
            $('question').innerText = 'å•é¡Œã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚';
        }
    }

    function displayQuiz() {
        if (currentQuizIndex >= currentQuizSet.length) {
            $('question').innerText = '';
            $('options').innerHTML = '';
            $('feedback').innerText = '';
            $('submit').style.display = 'none';
            $('next').style.display = 'none';
            $('explanation').style.display = 'none';
            $('explanation-toggle').style.display = 'none';

            let emoji = score <= 5 ? 'ğŸ˜¢' : score <= 8 ? 'ğŸ˜Š' : 'ğŸ¤©';
            $('score').innerText = `ã‚ãªãŸã®ã‚¹ã‚³ã‚¢: ${score} / ${NUM_QUESTIONS} ç‚¹ ${emoji}`;
            $('restart').style.display = 'inline-block';
            $('back-to-top-container').style.display = 'block';
            return;
        }

        const quiz = currentQuizSet[currentQuizIndex];
        $('question').innerText = `Q.${currentQuizIndex + 1} ${quiz.question}`;
        const optionsContainer = $('options');
        optionsContainer.innerHTML = '';
        $('feedback').innerText = '';
        $('explanation').innerText = '';
        $('explanation').style.display = 'none';
        $('explanation-toggle').style.display = 'none';
        $('submit').style.display = 'inline-block';
        $('submit').disabled = false;
        $('next').style.display = 'none';
        $('next').disabled = true;

        let questionImage = $('question-image');
        if (questionImage) questionImage.remove();
        if (quiz.image) {
            questionImage = document.createElement('img');
            questionImage.id = 'question-image';
            questionImage.src = quiz.image;
            questionImage.alt = 'å•é¡Œã®å›³';
            questionImage.style.cssText = 'max-width:100%;height:auto;display:block;margin:10px auto';
            document.querySelector('.q-sec').insertBefore(questionImage, optionsContainer);
        }

        const shuffledOptions = shuffleArray([...quiz.options]);
        shuffledOptions.forEach(option => {
            const label = document.createElement('label');
            const input = document.createElement('input');
            input.type = 'checkbox';
            input.name = 'quiz-option';
            input.value = option.key;
            label.appendChild(input);
            label.appendChild(document.createTextNode(option.text));
            optionsContainer.appendChild(label);
        });
    }

    function showExplanation(quiz) {
        const explanationDiv = $('explanation');
        const fullExplanation = quiz.explanation || 'è§£èª¬ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚';
        explanationDiv.textContent = fullExplanation;

        const toggleButton = $('explanation-toggle');
        toggleButton.style.display = 'block';
        toggleButton.textContent = 'ğŸ“– è§£èª¬ã‚’è¦‹ã‚‹'; 
        explanationDiv.style.display = 'none';
    }

    $('submit').addEventListener('click', () => {
        const quiz = currentQuizSet[currentQuizIndex];
        const selectedOptionKeys = Array.from(document.querySelectorAll('input[name="quiz-option"]:checked')).map(input => input.value);
        const feedbackText = $('feedback');
        const allOptionLabels = document.querySelectorAll('.options label');

        allOptionLabels.forEach(label => {
            const input = label.querySelector('input');
            input.disabled = true;

            const optionKey = input.value;
            const isCorrectOption = quiz.answer_keys.includes(optionKey);
            const isSelected = selectedOptionKeys.includes(optionKey);

            if (isCorrectOption) {
                label.classList.add('correct');
            } else if (isSelected) {
                label.classList.add('incorrect');
            }

            const optionData = quiz.options.find(o => o.key === optionKey);
            if (optionData && optionData.explanation) {
                const explanationDiv = document.createElement('div');
                explanationDiv.className = 'option-explanation';
                explanationDiv.style.cssText = 'margin-top: 15px; font-weight: bold; margin-left: 20px;';
                
                // æ”¹è¡Œã‚’å…¥ã‚Œã‚‹ã«ã¯ innerHTML ã‚’ä½¿ã† " 'è§£èª¬:<br>' +  "
                explanationDiv.innerHTML = optionData.explanation.trim().replace(/\n/g, '<br>');
                
                label.appendChild(explanationDiv);
            }

        });

        $('submit').style.display = 'none';
        $('next').style.display = 'inline-block';
        $('next').disabled = false;

        const sortedSelectedKeys = [...selectedOptionKeys].sort();
        const sortedCorrectKeys = [...quiz.answer_keys].sort();

        if (sortedSelectedKeys.length === sortedCorrectKeys.length &&
            sortedSelectedKeys.every((value, index) => value === sortedCorrectKeys[index])) {
            feedbackText.innerText = 'æ­£è§£ï¼';
            feedbackText.className = 'feedback correct';
            score++;
        } else {
            feedbackText.innerText = 'ä¸æ­£è§£';
            feedbackText.className = 'feedback incorrect';
        }

        showExplanation(quiz);
    });

    $('explanation-toggle').addEventListener('click', () => {
        const explanationDiv = $('explanation');
        const isVisible = explanationDiv.style.display === 'block';
        explanationDiv.style.display = isVisible ? 'none' : 'block';
        $('explanation-toggle').textContent = isVisible ? 'ğŸ“– è§£èª¬ã‚’è¦‹ã‚‹' : 'ğŸ“– è§£èª¬ã‚’é–‰ã˜ã‚‹';
    });

    $('next').addEventListener('click', () => {
        currentQuizIndex++;
        displayQuiz();
    });

    $('restart').addEventListener('click', () => {
        loadQuizzes();
    });

    loadQuizzes();
</script>
</body>
</html>
