<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>åœ°åŸŸé™å®šæ—…è¡Œæ¥­å‹™å–æ‰±ç®¡ç†è€…è©¦é¨“ éå»å•ã‚¯ã‚¤ã‚º V2</title>
    <style>html{overflow-y:scroll}body{font-family:Arial,sans-serif;margin:20px;background-color:#f4f4f4;color:#333}.container{background-color:#fff;padding:20px;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,.1);max-width:800px;margin:0 auto}.q-sec{margin-bottom:20px;padding-bottom:20px}.question{font-size:1em;margin-bottom:15px;font-weight:bold}.question-image{max-width:100%;height:auto;display:block;margin:15px auto}.options label{display:block;background-color:#e9e9e9;padding:10px;margin-bottom:8px;border-radius:5px;cursor:pointer;transition:background-color .3s}.options label:hover{background-color:#dcdcdc}.options input[type=checkbox]{margin-right:10px}.feedback{margin-top:15px;font-weight:bold;text-align:center}.feedback.correct{color:#28a745}.feedback.incorrect{color:#dc3545}.btn,button{background-color:#007bff;color:#fff;padding:10px 20px;border:none;border-radius:5px;cursor:pointer;font-size:1em;transition:background-color .3s;margin:0 5px}.btn:hover,button:hover{background-color:#0056b3}.btn:disabled,button:disabled{background-color:#ccc;cursor:not-allowed}.actions{text-align:center;margin-top:20px}#score{text-align:center;font-size:1.5em;font-weight:bold;margin-bottom:10px;color:#0056b3}.options label.correct{border:2px solid #28a745;background-color:#d4edda}.options label.incorrect{border:2px solid #dc3545;background-color:#f8d7da}#explanation{white-space:pre-line;line-height:1.6;margin-top:15px;padding:15px;background-color:#f8f9fa;border-left:4px solid #007bff;border-radius:0 5px 5px 0}.explanation-toggle{display:block;margin:15px auto 0 auto;width:auto}.loading{text-align:center;padding:20px;font-size:1.2em;color:#007bff}.progress{text-align:center;margin-bottom:10px;color:#666}.option-explanation{margin-top:10px;font-weight:bold;margin-left:25px;color:#555;font-size:.9em}.image-error{background-color:#f8d7da;color:#721c24;padding:10px;border-radius:5px;margin:10px 0;text-align:center;border:1px solid #f1b0b7}</style>
</head>
<body>
<div class="container">
    <h2 style="text-align: center;">åœ°åŸŸé™å®šæ—…è¡Œæ¥­å‹™å–æ‰±ç®¡ç†è€… éå»å•ã‚¯ã‚¤ã‚º</h2>
    <div id="progress" class="progress"></div>
    <div class="q-sec">
        <div class="question" id="question"></div>
        <div class="options" id="options"></div>
        <div class="feedback" id="feedback"></div>
        <button id="explanation-toggle" class="explanation-toggle" style="display:none;">ğŸ“– è§£èª¬ã‚’è¦‹ã‚‹</button>
        <div id="explanation" style="display:none;"></div>
    </div>
    <div class="actions">
        <button id="submit">â–¶ï¸ è§£ç­”ã™ã‚‹</button>
        <button id="next" disabled>â¡ï¸ æ¬¡ã®å•é¡Œ</button>
        <div id="score"></div>
        <button id="restart" style="display:none;">ğŸ”„ ã‚„ã‚Šç›´ã™</button>
        <div id="back-to-top-container" style="display:none; margin-top: 15px;">
            <a href="index.html" style="text-decoration: underline; color: #007bff;">ãƒˆãƒƒãƒ—ã«æˆ»ã‚‹</a>
        </div>
    </div>
</div>

<script>
    let allQuestionFiles = [], selectedQuestionFiles = [], currentQuizIndex = 0, score = 0, currentQuiz = null;
    const NUM_QUESTIONS = 10;
    const $ = id => document.getElementById(id);
    const questionCache = new Map();

    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    async function initializeQuiz() {
        try {
            const response = await fetch('data/quizzes/index.json');
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const indexData = await response.json();
            allQuestionFiles = indexData.question_files;

            if (!Array.isArray(allQuestionFiles) || allQuestionFiles.length === 0) {
                throw new Error('ã‚¯ã‚¤ã‚ºã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            }

            startNewGame();
        } catch (error) {
            console.error('Error loading quiz index:', error);
            $('question').innerText = 'å•é¡Œã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚';
        }
    }

    function startNewGame() {
        selectedQuestionFiles = shuffleArray([...allQuestionFiles]).slice(0, NUM_QUESTIONS);
        currentQuizIndex = 0;
        score = 0;
        currentQuiz = null;
        questionCache.clear();

        $('score').innerText = '';
        $('restart').style.display = 'none';
        $('back-to-top-container').style.display = 'none';
        
        loadAndDisplayQuiz();
        
        // å…ˆèª­ã¿
        if (selectedQuestionFiles.length > 1) {
            preloadQuestion(selectedQuestionFiles[1]);
        }
    }

    async function fetchQuestion(fileName) {
        if (questionCache.has(fileName)) {
            return questionCache.get(fileName);
        }
        const response = await fetch(`data/quizzes/${fileName}`);
        if (!response.ok) throw new Error(`Failed to fetch ${fileName}`);
        const data = await response.json();
        const question = data[0]; // JSONã¯é…åˆ—ã®æœ€åˆã®è¦ç´ 
        questionCache.set(fileName, question);
        return question;
    }

    async function preloadQuestion(fileName) {
        try {
            await fetchQuestion(fileName);
        } catch (error) {
            console.warn(`Failed to preload ${fileName}:`, error);
        }
    }

    async function loadAndDisplayQuiz() {
        if (currentQuizIndex >= selectedQuestionFiles.length) {
            showFinalScore();
            return;
        }

        $('question').innerHTML = '<div class="loading">ğŸ“– å•é¡Œã‚’èª­ã¿è¾¼ã¿ä¸­...</div>';
        $('options').innerHTML = '';
        $('feedback').innerText = '';
        $('explanation').style.display = 'none';
        $('explanation-toggle').style.display = 'none';
        $('submit').style.display = 'inline-block';
        $('submit').disabled = true;
        $('next').style.display = 'none';

        // æ—¢å­˜ã®ç”»åƒã¨ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤
        removeExistingImageElements();

        try {
            const fileName = selectedQuestionFiles[currentQuizIndex];
            currentQuiz = await fetchQuestion(fileName);
            displayQuiz();
            $('submit').disabled = false;

            // æ¬¡ã®å•é¡Œã‚’å…ˆèª­ã¿
            const nextIndex = currentQuizIndex + 1;
            if (nextIndex < selectedQuestionFiles.length) {
                preloadQuestion(selectedQuestionFiles[nextIndex]);
            }
        } catch (error) {
            console.error('Error loading quiz:', error);
            $('question').innerText = 'å•é¡Œã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
        }
    }

    function removeExistingImageElements() {
        // æ—¢å­˜ã®ç”»åƒè¦ç´ ã‚’å‰Šé™¤
        const existingImage = document.querySelector('.question-image');
        if (existingImage) {
            existingImage.remove();
        }
        
        // æ—¢å­˜ã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤
        const existingError = document.querySelector('.image-error');
        if (existingError) {
            existingError.remove();
        }
    }

    function displayQuiz() {
        $('progress').innerText = `å•é¡Œ ${currentQuizIndex + 1} / ${NUM_QUESTIONS}`;
        $('question').innerText = currentQuiz.q;
        
        const optionsContainer = $('options');
        optionsContainer.innerHTML = '';

        // ç”»åƒãŒã‚ã‚Œã°è¡¨ç¤º
        if (currentQuiz.i) {
            const questionImage = document.createElement('img');
            questionImage.className = 'question-image';
            questionImage.src = currentQuiz.i;
            questionImage.alt = 'å•é¡Œã®å›³';
            
            // ç”»åƒã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
            questionImage.onerror = function() {
                console.error('Failed to load image:', currentQuiz.i);
                this.style.display = 'none';
                
                // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                const errorDiv = document.createElement('div');
                errorDiv.className = 'image-error';
                errorDiv.textContent = `âš ï¸ ç”»åƒãŒèª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸ: ${currentQuiz.i}`;
                
                // å•é¡Œæ–‡ã®å¾Œã€é¸æŠè‚¢ã®å‰ã«æŒ¿å…¥
                const qSection = document.querySelector('.q-sec');
                qSection.insertBefore(errorDiv, optionsContainer);
            };
            
            questionImage.onload = function() {
                console.log('Image loaded successfully:', currentQuiz.i);
            };
            
            // å•é¡Œæ–‡ã®å¾Œã€é¸æŠè‚¢ã®å‰ã«ç”»åƒã‚’æŒ¿å…¥
            const qSection = document.querySelector('.q-sec');
            qSection.insertBefore(questionImage, optionsContainer);
        }

        currentQuiz.o.forEach((option, index) => {
            const [text, _] = option;
            const label = document.createElement('label');
            const input = document.createElement('input');
            input.type = 'checkbox';
            input.name = 'quiz-option';
            input.value = index;
            label.appendChild(input);
            label.appendChild(document.createTextNode(text));
            optionsContainer.appendChild(label);
        });
    }

    function showFinalScore() {
        $('question').innerText = '';
        $('options').innerHTML = '';
        $('feedback').innerText = '';
        $('submit').style.display = 'none';
        $('next').style.display = 'none';
        $('explanation').style.display = 'none';
        $('explanation-toggle').style.display = 'none';
        $('progress').innerText = `å…¨ ${NUM_QUESTIONS} å•ãŒçµ‚äº†ã—ã¾ã—ãŸã€‚`;

        // ç”»åƒè¦ç´ ã‚‚å‰Šé™¤
        removeExistingImageElements();

        let emoji = score <= (NUM_QUESTIONS * 0.5) ? 'ğŸ˜¢' : score <= (NUM_QUESTIONS * 0.8) ? 'ğŸ˜Š' : 'ğŸ¤©';
        $('score').innerText = `ã‚ãªãŸã®ã‚¹ã‚³ã‚¢: ${score} / ${NUM_QUESTIONS} ç‚¹ ${emoji}`;
        $('restart').style.display = 'inline-block';
        $('back-to-top-container').style.display = 'block';
    }

    $('submit').addEventListener('click', () => {
        const selectedOptions = Array.from(document.querySelectorAll('input[name="quiz-option"]:checked')).map(input => parseInt(input.value));
        
        const allOptionLabels = document.querySelectorAll('.options label');
        allOptionLabels.forEach((label, index) => {
            const input = label.querySelector('input');
            input.disabled = true;

            const isCorrect = currentQuiz.a.includes(index);
            const isSelected = selectedOptions.includes(index);

            if (isCorrect) {
                label.classList.add('correct');
            } else if (isSelected) {
                label.classList.add('incorrect');
            }

            // å€‹åˆ¥ã®é¸æŠè‚¢ã®è§£èª¬ã‚’è¡¨ç¤º
            const [_, explanationText] = currentQuiz.o[index];
            if (explanationText && explanationText.trim()) {
                const explanationDiv = document.createElement('div');
                explanationDiv.className = 'option-explanation';
                explanationDiv.innerHTML = explanationText.trim().replace(/\n/g, '<br>');
                label.appendChild(explanationDiv);
            }
        });

        const sortedSelected = [...selectedOptions].sort();
        const sortedCorrect = [...currentQuiz.a].sort();

        if (JSON.stringify(sortedSelected) === JSON.stringify(sortedCorrect)) {
            $('feedback').innerText = 'æ­£è§£ï¼';
            $('feedback').className = 'feedback correct';
            score++;
        } else {
            $('feedback').innerText = 'ä¸æ­£è§£';
            $('feedback').className = 'feedback incorrect';
        }

        $('submit').style.display = 'none';
        $('next').style.display = 'inline-block';
        $('next').disabled = false;

        // å…¨ä½“ã®è§£èª¬ã‚’è¡¨ç¤º
        if (currentQuiz.e && currentQuiz.e.trim()) {
            $('explanation').innerHTML = currentQuiz.e.trim().replace(/\n/g, '<br>');
            $('explanation-toggle').style.display = 'block';
        }
    });

    $('explanation-toggle').addEventListener('click', () => {
        const explanationDiv = $('explanation');
        const isVisible = explanationDiv.style.display === 'block';
        explanationDiv.style.display = isVisible ? 'none' : 'block';
        $('explanation-toggle').textContent = isVisible ? 'ğŸ“– è§£èª¬ã‚’è¦‹ã‚‹' : 'ğŸ“– è§£èª¬ã‚’é–‰ã˜ã‚‹';
    });

    $('next').addEventListener('click', () => {
        currentQuizIndex++;
        loadAndDisplayQuiz();
    });

    $('restart').addEventListener('click', () => {
        startNewGame();
    });

    // ã‚¯ã‚¤ã‚ºé–‹å§‹
    initializeQuiz();
</script>
</body>
</html>