<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>åœ°åŸŸé™å®šæ—…è¡Œæ¥­å‹™å–æ‰±ç®¡ç†è€…è©¦é¨“ éå»å•ã‚¯ã‚¤ã‚º - ãƒ‡ãƒãƒƒã‚°ç‰ˆ</title>
    <style>
        html {
            overflow-y: scroll;
        }
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f4;
            color: #333;
        }
        .container {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            max-width: 800px;
            margin: 0 auto;
        }
        .debug-panel {
            background-color: #e8f4f8;
            border: 2px solid #007bff;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
        }
        .debug-title {
            color: #007bff;
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 15px;
            text-align: center;
        }
        .question-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: white;
        }
        .question-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .question-item:hover {
            background-color: #f8f9fa;
        }
        .question-item.selected {
            background-color: #007bff;
            color: white;
        }
        .question-item:last-child {
            border-bottom: none;
        }
        .current-question-info {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-weight: bold;
            color: #495057;
            text-align: center;
        }
        .q-sec {
            margin-bottom: 20px;
            padding-bottom: 20px;
        }
        .question {
            font-size: 1em;
            margin-bottom: 15px;
            font-weight: bold;
        }
        .options label {
            display: block;
            background-color: #e9e9e9;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .options label:hover {
            background-color: #dcdcdc;
        }
        .options input[type="checkbox"] {
            margin-right: 10px;
        }
        .feedback {
            margin-top: 15px;
            font-weight: bold;
            text-align: center;
        }
        .feedback.correct {
            color: #28a745;
        }
        .feedback.incorrect {
            color: #dc3545;
        }
        .btn, button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s;
            margin: 0 5px;
        }
        .btn:hover, button:hover {
            background-color: #0056b3;
        }
        .btn:disabled, button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .actions {
            text-align: center;
            margin-top: 20px;
        }
        .options label.correct {
            border: 2px solid #28a745;
            background-color: #d4edda;
        }
        .options label.incorrect {
            border: 2px solid #dc3545;
            background-color: #f8d7da;
        }
        #explanation {
            white-space: pre-line;
            line-height: 1.6;
            margin-top: 15px;
            padding: 15px;
            background-color: #f8f9fa;
            border-left: 4px solid #007bff;
            border-radius: 0 5px 5px 0;
        }
        .explanation-toggle {
            display: block;
            margin: 15px auto 0 auto;
            width: auto;
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s;
        }
        .explanation-toggle:hover {
            background-color: #0056b3;
        }
        .option-explanation {
            margin-top: 15px;
            font-weight: bold;
            margin-left: 20px;
        }
        .nav-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }
        .debug-info {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            padding: 10px;
            margin-top: 15px;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
<div class="container">
    <h2 style="text-align: center;">åœ°åŸŸé™å®šæ—…è¡Œæ¥­å‹™å–æ‰±ç®¡ç†è€… éå»å•ã‚¯ã‚¤ã‚º - ãƒ‡ãƒãƒƒã‚°ç‰ˆ</h2>
    
    <div class="debug-panel">
        <div class="debug-title">ğŸ”§ ãƒ‡ãƒãƒƒã‚°æ©Ÿèƒ½</div>
        
        <div class="search-controls">
            <select id="question-select" class="select-input">
                <option value="">å•é¡Œã‚’é¸æŠ...</option>
            </select>
            <button id="load-selected" class="btn" style="margin-top: 35px;">é¸æŠã—ãŸå•é¡Œã‚’è¡¨ç¤º</button>
        </div>
        
        <div class="current-question-info" id="current-info" style="display: none;"></div>
        
        <div class="debug-info" id="debug-info" style="display: none;"></div>
    </div>

    <div class="q-sec">
        <div class="question" id="question"></div>
        <div class="options" id="options"></div>
        <div class="feedback" id="feedback"></div>
        <button id="explanation-toggle" class="explanation-toggle" style="display:none;">ğŸ“– è§£èª¬ã‚’è¦‹ã‚‹</button>
        <div id="explanation" style="display:none;"></div>
    </div>
    
    <div class="actions">
        <button id="submit">â–¶ï¸ è§£ç­”ã™ã‚‹</button>
        <div class="nav-buttons">
            <button id="prev-question" disabled>â¬…ï¸ å‰ã®å•é¡Œ</button>
            <button id="next-question" disabled>â¡ï¸ æ¬¡ã®å•é¡Œ</button>
        </div>
        <div style="margin-top: 15px;">
            <a href="index.html" style="text-decoration: underline; color: #007bff;">ãƒˆãƒƒãƒ—ã«æˆ»ã‚‹</a>
        </div>
    </div>
</div>

<script>
    let allQuizzes = [], currentQuizIndex = -1, filteredQuizzes = [], selectedQuizId = null;
    const $ = id => document.getElementById(id);

    async function loadQuizzes() {
        try {
            const indexResponse = await fetch('data/quizzes/index.json');
            if (!indexResponse.ok) throw new Error(`HTTP error! status: ${indexResponse.status}`);
            const indexData = await indexResponse.json();
            const allQuestionFiles = indexData.question_files;

            if (!Array.isArray(allQuestionFiles) || allQuestionFiles.length === 0) {
                throw new Error('ã‚¯ã‚¤ã‚ºã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            }

            const quizPromises = allQuestionFiles.map(async (fileName, index) => {
                const response = await fetch(`data/quizzes/${fileName}`);
                if (!response.ok) throw new Error(`Failed to fetch ${fileName}`);
                const data = await response.json();
                const question = data[0];
                question.o = question.o.map((option, optIndex) => [...option, optIndex]);
                const match = fileName.match(/q(\d+)\.json/);
                question.number = match ? parseInt(match[1], 10) : index + 1;
                return question;
            });

            allQuizzes = await Promise.all(quizPromises);

            filteredQuizzes = [...allQuizzes];
            populateQuestionSelect();
            updateDebugInfo();
            
        } catch (error) {
            console.error('Error loading quiz data:', error);
            $('question').innerText = 'å•é¡Œã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚';
        }
    }

    function populateQuestionSelect() {
        const select = $('question-select');
        select.innerHTML = '<option value="">å•é¡Œã‚’é¸æŠ...</option>';
        
        allQuizzes.forEach((quiz, index) => {
            const option = document.createElement('option');
            option.value = index;
            option.textContent = `Q.${quiz.number}`;
            select.appendChild(option);
        });
    }

    function updateQuestionList(quizzes) {
        // æ¤œç´¢æ©Ÿèƒ½å‰Šé™¤ã®ãŸã‚ã€ã“ã®é–¢æ•°ã¯ä¸è¦ã«ãªã‚‹ãŒã€å¿µã®ãŸã‚æ®‹ã—ã¦ãŠã
        // å¿…è¦ã§ã‚ã‚Œã°å¾Œã§å‰Šé™¤ã™ã‚‹
        const listContainer = $('question-list');
        listContainer.innerHTML = '';
        
        if (quizzes.length === 0) {
            listContainer.innerHTML = '<div class="question-item" style="text-align: center; color: #666;">è©²å½“ã™ã‚‹å•é¡ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div>';
            listContainer.style.display = 'block';
            return;
        }
        
        quizzes.forEach((quiz, index) => {
            const item = document.createElement('div');
            item.className = 'question-item';
            item.textContent = `Q.${quiz.number}: ${quiz.q}`;
            item.dataset.quizIndex = quiz.originalIndex;
            
            if (selectedQuizId === quiz.originalIndex) {
                item.classList.add('selected');
            }
            
            item.addEventListener('click', () => {
                selectedQuizId = quiz.originalIndex;
                currentQuizIndex = quiz.originalIndex;
                displayQuiz();
                updateCurrentInfo();
                updateDebugInfo();
                
                // é¸æŠçŠ¶æ…‹ã‚’æ›´æ–°
                document.querySelectorAll('.question-item').forEach(el => el.classList.remove('selected'));
                item.classList.add('selected');
                
                // ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚‚æ›´æ–°
                $('question-select').value = quiz.originalIndex;
            });
            
            listContainer.appendChild(item);
        });
        
        listContainer.style.display = 'block';
    }

    function updateCurrentInfo() {
        const info = $('current-info');
        if (currentQuizIndex >= 0 && currentQuizIndex < allQuizzes.length) {
            const quiz = allQuizzes[currentQuizIndex];
            info.textContent = `ç¾åœ¨è¡¨ç¤ºä¸­: Q.${quiz.number} / å…¨${allQuizzes.length}å•`;
            info.style.display = 'block';
        } else {
            info.style.display = 'none';
        }
    }

    function updateDebugInfo() {
        const debugInfo = $('debug-info');
        if (currentQuizIndex >= 0 && currentQuizIndex < allQuizzes.length) {
            const quiz = allQuizzes[currentQuizIndex];
            debugInfo.innerHTML = `
                <strong>ãƒ‡ãƒãƒƒã‚°æƒ…å ±:</strong><br>
                å•é¡ŒID: ${quiz.number}<br>
                æ­£è§£: ${quiz.a.join(', ')}<br>
                é¸æŠè‚¢æ•°: ${quiz.o.length}å€‹
            `;
            debugInfo.style.display = 'block';
        } else {
            debugInfo.style.display = 'none';
        }
    }

    function displayQuiz() {
        if (currentQuizIndex < 0 || currentQuizIndex >= allQuizzes.length) {
            $('question').innerText = 'å•é¡Œã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚';
            $('options').innerHTML = '';
            $('feedback').innerText = '';
            $('explanation').style.display = 'none';
            $('explanation-toggle').style.display = 'none';
            $('submit').disabled = true;
            updateNavigationButtons();
            return;
        }

        const quiz = allQuizzes[currentQuizIndex];
        $('question').innerText = `Q.${quiz.number} ${quiz.q}`;
        const optionsContainer = $('options');
        optionsContainer.innerHTML = '';
        $('feedback').innerText = '';
        $('explanation').innerText = '';
        $('explanation').style.display = 'none';
        $('explanation-toggle').style.display = 'none';
        $('submit').style.display = 'inline-block';
        $('submit').disabled = false;

        // ç”»åƒãŒã‚ã‚Œã°è¡¨ç¤º
        const existingImage = document.querySelector('.question-image');
        if (existingImage) existingImage.remove();
        const existingError = document.querySelector('.image-error');
        if (existingError) existingError.remove();

        if (quiz.i) {
            const questionImage = document.createElement('img');
            questionImage.className = 'question-image';
            questionImage.src = quiz.i;
            questionImage.alt = 'å•é¡Œã®å›³';
            
            questionImage.onerror = function() {
                console.error('Failed to load image:', quiz.i);
                this.style.display = 'none';
                const errorDiv = document.createElement('div');
                errorDiv.className = 'image-error';
                errorDiv.textContent = `âš ï¸ ç”»åƒãŒèª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸ: ${quiz.i}`;
                const qSec = document.querySelector('.q-sec');
                qSec.insertBefore(errorDiv, optionsContainer);
            };
            
            questionImage.onload = function() {
                console.log('Image loaded successfully:', quiz.i);
            };
            const qSec = document.querySelector('.q-sec');
            qSec.insertBefore(questionImage, optionsContainer);
        }

        // é¸æŠè‚¢ã‚’è¡¨ç¤ºï¼ˆã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ãªã„ï¼‰
        quiz.o.forEach((option, index) => {
            const [text, _, originalIndex] = option;
            const label = document.createElement('label');
            const input = document.createElement('input');
            input.type = 'checkbox';
            input.name = 'quiz-option';
            input.value = originalIndex;
            label.appendChild(input);
            label.appendChild(document.createTextNode(text));
            optionsContainer.appendChild(label);
        });

        updateNavigationButtons();
        updateCurrentInfo();
        updateDebugInfo();
    }

    function updateNavigationButtons() {
        $('prev-question').disabled = currentQuizIndex <= 0;
        $('next-question').disabled = currentQuizIndex >= allQuizzes.length - 1;
    }

    function showExplanation(quiz) {
        const explanationDiv = $('explanation');
        const fullExplanation = quiz.e || 'è§£èª¬ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚';
        explanationDiv.innerHTML = fullExplanation.trim().replace(/\n/g, '<br>');

        const toggleButton = $('explanation-toggle');
        toggleButton.style.display = 'block';
        toggleButton.textContent = 'ğŸ“– è§£èª¬ã‚’è¦‹ã‚‹'; 
        explanationDiv.style.display = 'none';
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    $('load-selected').addEventListener('click', () => {
        const selectedIndex = parseInt($('question-select').value);
        if (!isNaN(selectedIndex) && selectedIndex >= 0 && selectedIndex < allQuizzes.length) {
            selectedQuizId = selectedIndex;
            currentQuizIndex = selectedIndex;
            displayQuiz();
        }
    });

    $('submit').addEventListener('click', () => {
        const quiz = allQuizzes[currentQuizIndex];
        const selectedOriginalIndices = Array.from(document.querySelectorAll('input[name="quiz-option"]:checked')).map(input => parseInt(input.value));
        const feedbackText = $('feedback');
        const allOptionLabels = document.querySelectorAll('.options label');

        allOptionLabels.forEach(label => {
            const input = label.querySelector('input');
            input.disabled = true;

            const originalIndex = parseInt(input.value);
            const isCorrectOption = quiz.a.includes(originalIndex);
            const isSelected = selectedOriginalIndices.includes(originalIndex);

            if (isCorrectOption) {
                label.classList.add('correct');
            } else if (isSelected) {
                label.classList.add('incorrect');
            }

            const [_, explanationText] = quiz.o.find(opt => opt[2] === originalIndex);
            if (explanationText && explanationText.trim()) {
                const explanationDiv = document.createElement('div');
                explanationDiv.className = 'option-explanation';
                explanationDiv.innerHTML = explanationText.trim().replace(/\n/g, '<br>');
                label.appendChild(explanationDiv);
            }
        });

        $('submit').style.display = 'none';

        const sortedSelectedKeys = [...selectedOriginalIndices].sort();
        const sortedCorrectKeys = [...quiz.a].sort();

        if (sortedSelectedKeys.length === sortedCorrectKeys.length &&
            sortedSelectedKeys.every((value, index) => value === sortedCorrectKeys[index])) {
            feedbackText.innerText = 'æ­£è§£ï¼';
            feedbackText.className = 'feedback correct';
        } else {
            feedbackText.innerText = 'ä¸æ­£è§£';
            feedbackText.className = 'feedback incorrect';
        }

        showExplanation(quiz);
    });

    $('explanation-toggle').addEventListener('click', () => {
        const explanationDiv = $('explanation');
        const isVisible = explanationDiv.style.display === 'block';
        explanationDiv.style.display = isVisible ? 'none' : 'block';
        $('explanation-toggle').textContent = isVisible ? 'ğŸ“– è§£èª¬ã‚’è¦‹ã‚‹' : 'ğŸ“– è§£èª¬ã‚’é–‰ã˜ã‚‹';
    });

    $('prev-question').addEventListener('click', () => {
        if (currentQuizIndex > 0) {
            currentQuizIndex--;
            selectedQuizId = currentQuizIndex;
            displayQuiz();
            $('question-select').value = currentQuizIndex;
        }
    });

    $('next-question').addEventListener('click', () => {
        if (currentQuizIndex < allQuizzes.length - 1) {
            currentQuizIndex++;
            selectedQuizId = currentQuizIndex;
            displayQuiz();
            $('question-select').value = currentQuizIndex;
        }
    });

    // åˆæœŸåŒ–
    loadQuizzes();
</script>
</body>
</html>